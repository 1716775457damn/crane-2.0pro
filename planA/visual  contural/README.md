# K210与ESP32S3视觉跟踪系统文档

## 一、系统概述

本系统采用K210和ESP32S3双芯片协同工作架构，实现基于Yolo2的数字识别和目标跟踪功能。K210负责视觉识别处理，ESP32S3负责舵机控制、OLED显示和系统协调。

## 二、目录结构

```
visual contural/
├── ESP32_Number_Tracker/          # ESP32S3代码文件夹
│   └── ESP32_Number_Tracker.ino   # ESP32S3主程序
├── model-11975.nncase/            # K210 Yolo2模型文件夹
│   └── main.py                    # 原始模型测试程序
├── K210_Detection_Sender.py       # K210识别与串口发送程序
├── main.py                        # K210原始主程序
├── uart.py                        # K210串口通信模块
└── README.md                      # 本文档
```

## 三、硬件配置

### K210部分：
- **开发板**：Sipeed Maix Bit/Dock
- **摄像头**：OV2640/OV7740（224×224分辨率）
- **存储**：TF卡（存储模型文件）
- **接口**：UART、SPI、I2C

### ESP32S3部分：
- **开发板**：ESP32S3-DevKitC
- **显示屏**：SSD1306 OLED显示屏（I2C接口，128×64分辨率）
- **舵机**：双轴舵机模组（X轴、Y轴）
- **接口**：UART、I2C、GPIO

## 四、接线详细说明

### K210接线：
- **UART通信**：
  - K210的Pin 10 (TX) → ESP32S3的GPIO 18 (RX)
  - K210的Pin 11 (RX) → ESP32S3的GPIO 17 (TX)
- **摄像头**：
  - 连接到DVP专用接口
- **电源**：
  - 5V输入

### ESP32S3接线：
- **UART通信**：
  - GPIO 17 (TX) → K210的Pin 11 (RX)
  - GPIO 18 (RX) → K210的Pin 10 (TX)
- **OLED显示屏**：
  - SDA → GPIO引脚（代码中设置）
  - SCL → GPIO引脚（代码中设置）
  - VCC → 3.3V
  - GND → GND
- **舵机控制**：
  - X轴舵机信号线 → GPIO 25
  - Y轴舵机信号线 → GPIO 26
  - 舵机电源需要单独供电（5V/2A以上）

## 五、软件工作流程

### K210程序流程（K210_Detection_Sender.py）：
1. 初始化摄像头与LCD显示
2. 映射UART引脚（Pin 10与Pin 11）
3. 加载Yolo2模型（model-11975.kmodel）
4. 循环捕获图像并进行目标检测
5. 检测到数字后，通过UART发送格式化数据（数字,x,y,宽,高）
6. 在LCD上显示检测框与识别数字

### ESP32S3程序流程（ESP32_Number_Tracker.ino）：
1. 初始化UART、I2C和舵机控制
2. 在OLED上显示系统状态
3. 通过UART接收K210发送的识别数据
4. 解析数据并提取目标位置信息
5. 使用PID算法计算舵机控制量
6. 控制舵机移动，实现对目标的实时跟踪
7. 在OLED上显示识别结果和跟踪状态

## 六、主要功能模块

### 1. 目标检测模块（K210）：
- 基于Yolo2的目标检测算法
- 针对数字识别（1-8）优化的模型
- 实时检测帧率：约15-20FPS

### 2. 通信协议：
- **波特率**：115200
- **数据格式**：`数字,x,y,宽,高\r\n`
- **示例**：`1,120,80,30,40\r\n`（表示识别到数字1，位置(120,80)，尺寸30×40）
- **心跳包**：ESP32S3每5秒发送一次测试消息`ESP32S3_PING_x`，验证通信状态

### 3. PID跟踪系统（ESP32S3）：
- **参数设置**：Kp=0.1, Ki=0.01, Kd=0.05
- **控制算法**：
  ```cpp
  // PID计算代码片段
  float calcPID(float error, float &prevError, float &integral, float &derivative) {
    integral += error;
    derivative = error - prevError;
    prevError = error;
    return KP * error + KI * integral + KD * derivative;
  }
  ```
- **舵机控制**：限制角度范围0-180度，防止超出机械限位

### 4. 状态监控与调试：
- K210 LCD实时显示检测结果
- ESP32S3 OLED显示系统状态与目标位置
- 串口监视器输出详细调试信息

## 七、使用指南

### 1. 准备工作：
- 将`model-11975.kmodel`模型文件复制到K210的SD卡或Flash中
- 将`K210_Detection_Sender.py`程序烧录到K210中
- 将`ESP32_Number_Tracker.ino`程序通过Arduino IDE烧录到ESP32S3中
- 完成硬件连接，确保所有线路正确连接

### 2. 系统启动顺序：
- 先给K210上电，等待初始化完成（LCD显示启动信息）
- 再给ESP32S3上电，等待初始化完成（OLED显示"System ready"）
- 等待两个设备建立串口通信连接

### 3. 运行时调整：
- 可修改K210识别阈值（当前设置：confidence=0.5, nms=0.3）
- 可调整ESP32S3的PID参数，适应不同负载和响应要求
- 可调整舵机中心位置校准参数

## 八、常见问题与解决方法

### 1. K210无法识别目标：
- 检查光线条件，确保目标清晰可见
- 调整摄像头焦距，使图像清晰
- 检查模型文件是否正确加载

### 2. 舵机控制不准确：
- 检查PID参数，适当增大Kp提高响应性
- 确认舵机电源足够，舵机负载过大时需要独立电源
- 校准舵机中心位置和限位范围

### 3. 串口通信失败：
- 检查TX/RX连接是否正确（K210的TX连接ESP32S3的RX）
- 确认波特率设置一致（115200）
- 重启两个设备，重新建立通信

## 九、扩展与优化方向

### 1. 识别能力扩展：
- 重新训练模型以识别更多类型的目标
- 优化模型精度与速度，提高识别效果
- 添加目标跟踪算法，减少识别波动

### 2. 功能增强：
- 增加多目标同时跟踪能力
- 添加距离测量传感器，实现3D空间定位
- 集成底盘控制，实现全自主导航与跟踪

### 3. 系统稳定性：
- 增加通信错误处理和恢复机制
- 优化PID参数自适应调整
- 加入电源管理和低功耗模式 